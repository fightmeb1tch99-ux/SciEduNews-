# SciEduNews-
#!/usr/bin/env python3
# ============================================================
#   ü§ñ AI –ê–ì–ï–ù–¢ ‚Äî –ù–∞—É–∫–∞ –∏ –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
#   –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã: Telegram (+ Instagram/YouTube –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
#   AI: OpenRouter API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏)
#   –ó–∞–ø—É—Å–∫: GitHub Actions –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ ‚Äî –ë–ï–°–ü–õ–ê–¢–ù–û
# ============================================================

import feedparser
import requests
import os
import json
import time
import hashlib
from datetime import datetime

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –∏–∑ GitHub Secrets)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

OPENROUTER_API_KEY = os.environ["OPENROUTER_API_KEY"]   # openrouter.ai ‚Üí Keys
TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]   # @BotFather
TELEGRAM_CHAT_ID   = os.environ["TELEGRAM_CHAT_ID"]     # ID –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä. -1001234567890)

# –ú–æ–¥–µ–ª—å OpenRouter —Å –ø–æ–º–µ—Ç–∫–æ–π :free ‚Äî –≤—Å–µ–≥–¥–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ
# –õ–∏–º–∏—Ç: 50 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å (–±–µ—Å–ø–ª–∞—Ç–Ω–æ) –∏–ª–∏ 1000/–¥–µ–Ω—å (–µ—Å–ª–∏ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ $10)
OPENROUTER_MODEL = "deepseek/deepseek-r1:free"  
# –†–µ–∑–µ—Ä–≤–Ω—ã–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞):
# "meta-llama/llama-3.3-70b-instruct:free"
# "google/gemma-3-27b-it:free"
# "mistralai/mistral-7b-instruct:free"
# "openrouter/auto"  ‚Üê –∞–≤—Ç–æ–≤—ã–±–æ—Ä –ª—É—á—à–µ–π —Å–≤–æ–±–æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# RSS –ò–°–¢–û–ß–ù–ò–ö–ò (–≤—Å–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

RSS_SOURCES = [
    {
        "url": "https://rss.arxiv.org/rss/cs.AI",
        "topic": "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
        "emoji": "ü§ñ"
    },
    {
        "url": "https://rss.arxiv.org/rss/physics",
        "topic": "–§–∏–∑–∏–∫–∞",
        "emoji": "‚öõÔ∏è"
    },
    {
        "url": "https://www.nasa.gov/rss/dyn/breaking_news.rss",
        "topic": "–ö–æ—Å–º–æ—Å",
        "emoji": "üöÄ"
    },
    {
        "url": "https://www.sciencedaily.com/rss/all.xml",
        "topic": "–ù–∞—É–∫–∞",
        "emoji": "üî¨"
    },
    {
        "url": "https://habr.com/ru/rss/flows/develop/articles/",
        "topic": "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
        "emoji": "üíª"
    },
    {
        "url": "https://habr.com/ru/rss/flows/education/articles/",
        "topic": "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
        "emoji": "üéì"
    },
]

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –®–ê–ì 1: –°–ë–û–† –ù–û–í–û–°–¢–ï–ô
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def get_news(max_per_source: int = 3) -> list[dict]:
    """–°–æ–±–∏—Ä–∞–µ–º —Å–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ RSS –ª–µ–Ω—Ç"""
    articles = []
    
    for source in RSS_SOURCES:
        try:
            feed = feedparser.parse(source["url"])
            for entry in feed.entries[:max_per_source]:
                # –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Å—Ç–∞—Ç—å–∏
                summary = getattr(entry, "summary", "") or getattr(entry, "description", "")
                if not summary or len(summary) < 50:
                    continue
                    
                articles.append({
                    "title":   entry.title,
                    "summary": summary[:800],  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                    "link":    getattr(entry, "link", ""),
                    "topic":   source["topic"],
                    "emoji":   source["emoji"],
                    # –•—ç—à –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–¥–Ω–æ –¥–≤–∞–∂–¥—ã)
                    "hash":    hashlib.md5(entry.title.encode()).hexdigest()[:8]
                })
        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {source['url']}: {e}")
            continue

    print(f"üì∞ –°–æ–±—Ä–∞–Ω–æ {len(articles)} –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ RSS")
    return articles


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –®–ê–ì 2: –§–ê–ö–¢–ß–ï–ö–ò–ù–ì –ò –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def filter_and_score(articles: list[dict]) -> list[dict]:
    """
    –ü—Ä–æ—Å—Ç–æ–π —Ñ–∏–ª—å—Ç—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤:
    - –£–±–∏—Ä–∞–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
    - –£–±–∏—Ä–∞–µ–º —è–≤–Ω—ã–π –∫–ª–∏–∫–±–µ–π—Ç –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    - –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ ¬´–Ω–∞—É—á–Ω–æ—Å—Ç–∏¬ª
    """
    CLICKBAIT_WORDS = [
        "—à–æ–∫", "—Å–µ–Ω—Å–∞—Ü–∏—è", "–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ", "–≤—ã –Ω–µ –ø–æ–≤–µ—Ä–∏—Ç–µ",
        "—Ä–∞–∑—Ä—É—à–∏—Ç", "—Å–∫—Ä—ã–≤–∞—é—Ç", "—Ç–∞–π–Ω–∞", "–∑–∞–≥–æ–≤–æ—Ä"
    ]
    SCIENCE_BOOST_WORDS = [
        "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "—É—á—ë–Ω—ã–µ", "—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç", "–æ—Ç–∫—Ä—ã—Ç–∏–µ",
        "study", "researchers", "discovered", "published", "journal"
    ]
    
    scored = []
    for a in articles:
        text = (a["title"] + " " + a["summary"]).lower()
        
        # –§–∏–ª—å—Ç—Ä –∫–ª–∏–∫–±–µ–π—Ç–∞
        if any(w in text for w in CLICKBAIT_WORDS):
            continue
            
        # –°–∫–æ—Ä–∏–Ω–≥ –Ω–∞—É—á–Ω–æ—Å—Ç–∏
        score = sum(1 for w in SCIENCE_BOOST_WORDS if w in text)
        a["score"] = score
        scored.append(a)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–∞–º—ã–µ "–Ω–∞—É—á–Ω—ã–µ" –≤–ø–µ—Ä—ë–¥
    scored.sort(key=lambda x: x["score"], reverse=True)
    print(f"‚úÖ –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {len(scored)} –Ω–æ–≤–æ—Å—Ç–µ–π")
    return scored


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –®–ê–ì 3: –ù–ê–ü–ò–°–ê–ù–ò–ï –ü–û–°–¢–ê –ß–ï–†–ï–ó OPENROUTER
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def write_post_openrouter(article: dict, platform: str = "telegram") -> str | None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç —á–µ—Ä–µ–∑ OpenRouter API
    –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å DeepSeek R1
    """
    
    # –ü—Ä–æ–º–ø—Ç—ã –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    prompts = {
        "telegram": f"""–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ Telegram-–∫–∞–Ω–∞–ª–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
        
–ù–∞–ø–∏—à–∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç –æ–± —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏:
–¢–µ–º–∞: {article['topic']} {article['emoji']}
–ó–∞–≥–æ–ª–æ–≤–æ–∫: {article['title']}
–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: {article['summary']}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É:
- –î–ª–∏–Ω–∞: 150-200 —Å–ª–æ–≤
- –ù–∞—á–Ω–∏ —Å –∏–Ω—Ç—Ä–∏–≥—É—é—â–µ–≥–æ —Ñ–∞–∫—Ç–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–∞
- –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Äî –±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞
- –û–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
- –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å–æ–º –∫ —á–∏—Ç–∞—Ç–µ–ª—è–º –¥–ª—è –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏
- –î–æ–±–∞–≤—å 4-5 —Ö—ç—à—Ç–µ–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
- –ü–∏—à–∏ –∂–∏–≤–æ –∏ —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º!

–§–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤—Ä–æ–¥–µ "–í–æ—Ç –ø–æ—Å—Ç:"
""",
        
        "instagram": f"""–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞—É—á–Ω–æ–≥–æ Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞.

–ù–∞–ø–∏—à–∏ –ø–æ–¥–ø–∏—Å—å –∫ –ø–æ—Å—Ç—É:
–¢–µ–º–∞: {article['topic']} {article['emoji']}
–ù–æ–≤–æ—Å—Ç—å: {article['title']}
–î–µ—Ç–∞–ª–∏: {article['summary']}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- 80-120 —Å–ª–æ–≤, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π —Å—Ç–∏–ª—å
- –ü–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏ ‚Äî —Ü–µ–ø–ª—è—é—â–∏–π –∫—Ä—é—á–æ–∫ (–≤–∞–∂–Ω–æ –¥–ª—è Instagram)
- 10-15 —Ö—ç—à—Ç–µ–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ (–º–∏–∫—Å —Ä—É—Å—Å–∫–∏—Ö –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö)
- –≠–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç–µ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
- –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é: "—Å–æ—Ö—Ä–∞–Ω–∏", "–ø–æ–¥–µ–ª–∏—Å—å", "–Ω–∞–ø–∏—à–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ö"

–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏:
"""
    }
    
    prompt = prompts.get(platform, prompts["telegram"])
    
    try:
        response = requests.post(
            url="https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                "Content-Type": "application/json",
                # –≠—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç OpenRouter –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
                "HTTP-Referer": "https://github.com/sciedu-agent",
                "X-Title": "SciEdu News Agent"
            },
            json={
                "model": OPENROUTER_MODEL,
                "messages": [
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                "max_tokens": 600,
                "temperature": 0.7,   # –ù–µ–º–Ω–æ–≥–æ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º
            },
            timeout=60  # –ñ–¥—ë–º –¥–æ 60 —Å–µ–∫—É–Ω–¥
        )
        
        if response.status_code == 200:
            data = response.json()
            text = data["choices"][0]["message"]["content"].strip()
            print(f"‚úçÔ∏è  –ü–æ—Å—Ç –Ω–∞–ø–∏—Å–∞–Ω ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤)")
            return text
            
        elif response.status_code == 429:
            print("‚è≥ –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ñ–¥—ë–º 60 —Å–µ–∫—É–Ω–¥...")
            time.sleep(60)
            return None
            
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ OpenRouter: {response.status_code} ‚Äî {response.text[:200]}")
            return None
            
    except requests.Timeout:
        print("‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter")
        return None
    except Exception as e:
        print(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return None


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –®–ê–ì 4: –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –í TELEGRAM
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def publish_telegram(text: str, source_link: str = "") -> bool:
    """–ü—É–±–ª–∏–∫—É–µ–º –ø–æ—Å—Ç –≤ Telegram –∫–∞–Ω–∞–ª"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
    full_text = text
    if source_link:
        full_text += f"\n\nüìé [–ò—Å—Ç–æ—á–Ω–∏–∫]({source_link})"
    
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    
    payload = {
        "chat_id": TELEGRAM_CHAT_ID,
        "text": full_text,
        "parse_mode": "Markdown",
        "disable_web_page_preview": False
    }
    
    try:
        response = requests.post(url, json=payload, timeout=15)
        
        if response.status_code == 200:
            print(f"üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ Telegram!")
            return True
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ Telegram: {response.status_code} ‚Äî {response.text[:200]}")
            return False
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {e}")
        return False


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –•–†–ê–ù–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

HISTORY_FILE = "published_hashes.json"

def load_history() -> set:
    """–ó–∞–≥—Ä—É–∂–∞–µ–º —Ö—ç—à–∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤"""
    if os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE, "r") as f:
            return set(json.load(f))
    return set()

def save_history(hashes: set):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 500 –∑–∞–ø–∏—Å–µ–π)"""
    recent = list(hashes)[-500:]
    with open(HISTORY_FILE, "w") as f:
        json.dump(recent, f)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def run_agent(posts_per_run: int = 2):
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–≥–µ–Ω—Ç–∞:
    1. –°–æ–±–∏—Ä–∞–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏
    2. –§–∏–ª—å—Ç—Ä—É–µ—Ç
    3. –ü–∏—à–µ—Ç –ø–æ—Å—Ç—ã —á–µ—Ä–µ–∑ OpenRouter
    4. –ü—É–±–ª–∏–∫—É–µ—Ç –≤ Telegram
    
    posts_per_run: —Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫
    (—Å –ª–∏–º–∏—Ç–æ–º 50/–¥–µ–Ω—å –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å 2 –ø–æ—Å—Ç–∞ √ó 8 –∑–∞–ø—É—Å–∫–æ–≤ = 16 –ø–æ—Å—Ç–æ–≤/–¥–µ–Ω—å)
    """
    
    print(f"\n{'='*50}")
    print(f"ü§ñ AI –ê–≥–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'='*50}\n")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    published = load_history()
    print(f"üìö –í –∏—Å—Ç–æ—Ä–∏–∏: {len(published)} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤\n")
    
    # –®–∞–≥ 1: –°–±–æ—Ä
    articles = get_news(max_per_source=3)
    
    # –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    articles = filter_and_score(articles)
    
    # –£–±–∏—Ä–∞–µ–º —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ
    new_articles = [a for a in articles if a["hash"] not in published]
    print(f"üÜï –ù–æ–≤—ã—Ö (–Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–≤—à–∏—Ö—Å—è): {len(new_articles)}\n")
    
    if not new_articles:
        print("‚ÑπÔ∏è  –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.")
        return
    
    # –®–∞–≥ 3+4: –ü–∏—à–µ–º –∏ –ø—É–±–ª–∏–∫—É–µ–º
    published_count = 0
    
    for article in new_articles[:posts_per_run]:
        print(f"\nüìå –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {article['title'][:60]}...")
        
        # –ü–∏—à–µ–º –ø–æ—Å—Ç
        post_text = write_post_openrouter(article, platform="telegram")
        
        if not post_text:
            print("‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—é...")
            continue
        
        # –ü—É–±–ª–∏–∫—É–µ–º
        success = publish_telegram(post_text, source_link=article.get("link", ""))
        
        if success:
            published.add(article["hash"])
            published_count += 1
        
        # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏ (–Ω–µ —Å–ø–∞–º–∏–º)
        if published_count < posts_per_run:
            time.sleep(30)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
    save_history(published)
    
    print(f"\n{'='*50}")
    print(f"‚úÖ –ì–æ—Ç–æ–≤–æ! –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {published_count} –ø–æ—Å—Ç–æ–≤")
    print(f"{'='*50}\n")


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –¢–û–ß–ö–ê –í–•–û–î–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if __name__ == "__main__":
    run_agent(posts_per_run=2)
